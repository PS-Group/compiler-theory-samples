# Минимальная поддержка процедурного стиля в интерпретаторе

Интерпретатор по-прежнему читае ввод построчно, строит AST и с его помощью выполняет инструкции.

С предыдущей итерации поддерживаются переменные, присваивания, печать выражений, управляющие инструкции `if`, `if .. else`, `while`, `do .. while`. В данном примере добавлена минимальная поддержка процедурного подхода:

- пользовательские функции, принимающие (0..∞) аргументов
- встроенные функции `sin(x)` и `rand(min, max)`
- вызов функций
- инструкция `return`
- смена области видимости переменных внутри функции

##### Ввод
```
def sqr(x)
  result = x * x
  return result
end

result = 2016
x = 2016
y = sqr(10)
print y
print x
print result
```

##### Вывод
```
result: 100
result: 2016
result: 2016
```

### Изменения в сравнении с lemon-6-full-structured

Новые узлы AST:

- CReturnAST (подкласс IStatementAST)
- CCallAST (подкласс IExpressionAST)
- CFunctionAST (подкласс IFunctionAST)

Новые классы:

- CVariablesScope реализует область видимости переменных. Создаётся узлами `CProgramAST` и `CFunctionAST`.
- CRandFunction реализует встроенную функцию `rand(min, max)`
- CSinFunction реализует встроенную функцию `sin(x)`

Рефакторинг обработки вложенных statements:

- из класса CBatchParser убраны методы EnterBlock и ExitBlock, больше не хранится стек текущих блоков
- вместо этого некоторые правила Lemon-грамматики хранят в своей ячейке стека тип данных "`std::vector<T> *`"
- для гарантии безопасности работы со списками в `CBatchParser_private.h` описаны шаблонные функции, автоматически выводящие свои типы из типов ячеек стека, переданных как аргументы. Это позволило сжать действия атрибутной грамматики до 1-й строки в большинстве правил
- удалось избавится от дополнительных правил, необходимых для раннего формирования родительского AST (до свёртки дочерних statements), так как теперь можно свернуть дочерние statements перед созданием родительского AST.
- количество правил и нетерминалов в Lemon-грамматике заметно уменьшилось

Новые нетерминалы в `BatchGrammar.lemon`:

- `function_declaration` для определения пользовательской функции
- `parameter_list` для сборки списка параметров функции
- `expression_list` для сборки списка аргументов функции
- `toplevel_list`, `toplevel_line`, `toplevel_statement` позволяют интерпретатору автоматически выполнять инструкции, расположенные на верхнем уровне, а также не дают объявлять вложенные куда-либо функции

Новые отдельные правила:

- вызов функции: `expression ::= ID LPAREN expression_list RPAREN.`
- инструкция return: `statement ::= RETURN expression.`

### Системные требования

- Для ОС Ubuntu: установите пакет `lemon`
- Для ОС Windows: соберите Lemon из [исходных кодов (hwaci.com)](http://www.hwaci.com/sw/lemon/). Исходники Lemon состоят всего из двух файлов, `lemon.c` и `lempar.c`. Используйте любой современный компилятор C/C++.
